"""–°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ ¬´–ú–∞—Ç–µ—Ä–∏–∞–ª—ã¬ª —Å–æ —Å–±–æ—Ä–æ–º —Ñ–æ—Ç–æ."""

from __future__ import annotations

import asyncio
import datetime as dt
import logging
import re
from pathlib import Path
from typing import TYPE_CHECKING

from aiogram import F, Router, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import ReplyKeyboardBuilder

from features.utils.messaging import safe_delete
from services.drive import get_drive
from services.drive_yadisk import YaDiskError, YaDiskService
from services.sheets import SheetsService

if TYPE_CHECKING:  # pragma: no cover
    from features.shift_menu import render_shift_menu as RenderShiftMenuFn

router = Router()
logger = logging.getLogger(__name__)
_sheets_service: SheetsService | None = None
_drive_service: YaDiskService | None = None


def _get_sheets_service() -> SheetsService:
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ Google Sheets."""

    global _sheets_service
    if _sheets_service is None:
        _sheets_service = SheetsService()
    return _sheets_service


def _get_drive_service() -> YaDiskService:
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤."""

    global _drive_service
    if _drive_service is None:
        _drive_service = get_drive()
    return _drive_service


def _render_shift_menu(*args, **kwargs):
    """–õ–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç –º–µ–Ω—é —Å–º–µ–Ω—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π."""

    from features.shift_menu import render_shift_menu

    return render_shift_menu(*args, **kwargs)


BTN_BACK = "‚¨Ö –ù–∞–∑–∞–¥"
BTN_HOME = "üè† –í –º–µ–Ω—é"
BTN_SKIP = "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
BTN_CONFIRM = "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
BTN_DEL_LAST = "üóë –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ"


def nav_kb(extra: list[str] | None = None) -> types.ReplyKeyboardMarkup:
    """–°—Ç—Ä–æ–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –±–∞–∑–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π."""

    keyboard = ReplyKeyboardBuilder()
    if extra:
        for item in extra:
            keyboard.button(text=item)
        keyboard.adjust(len(extra))
    keyboard.button(text=BTN_BACK)
    keyboard.button(text=BTN_HOME)
    keyboard.adjust(2)
    return keyboard.as_markup(resize_keyboard=True)


def only_digits(text: str) -> int | None:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ None, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π."""

    stripped = (text or "").strip()
    if stripped == BTN_SKIP:
        return 0
    return int(stripped) if re.fullmatch(r"\d+", stripped) else None


class MaterialsFSM(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤."""

    pvd = State()
    pvc = State()
    tape = State()
    photos = State()
    confirm = State()


@router.message(Command("materials"))
async def start_materials(message: types.Message, state: FSMContext) -> None:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤."""

    await safe_delete(message)
    user_id = message.from_user.id
    sheets = _get_sheets_service()
    row = await asyncio.to_thread(sheets.get_shift_row_index_for_user, user_id)
    if row is None:
        row = await asyncio.to_thread(sheets.open_shift_for_user, user_id)

    day_title = _format_day_title(dt.datetime.now().astimezone().date())

    try:
        drive = _get_drive_service()
        await asyncio.to_thread(drive.get_or_create_daily_folder, day_title)
    except (YaDiskError, RuntimeError, ValueError) as exc:
        logger.exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–∞–ø–∫—É –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: %s", exc)
        await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∫–µ–Ω–∞ "
            "–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
        await state.clear()
        await _render_shift_menu(message, user_id, row)
        return

    await state.update_data(
        user_id=user_id,
        row=row,
        photos=[],
        day_title=day_title,
    )
    await ask_pvd(message, state)


async def ask_pvd(message: types.Message, state: FSMContext) -> None:
    await state.set_state(MaterialsFSM.pvd)
    await message.answer(
        "—É–∫–∞–∂–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥ —Ä—É–ª–æ–Ω–æ–≤ –ü–í–î (–≤ –º–µ—Ç—Ä–∞—Ö).",
        reply_markup=nav_kb([BTN_SKIP]),
    )


@router.message(MaterialsFSM.pvd)
async def input_pvd(message: types.Message, state: FSMContext) -> None:
    if message.text in (BTN_BACK, BTN_HOME):
        return await exit_nav(message, state, message.text)
    value = only_digits(message.text or "")
    if value is None:
        return await message.answer("—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–ª–∏ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª.")
    await state.update_data(pvd=value)
    await ask_pvc(message, state)


async def ask_pvc(message: types.Message, state: FSMContext) -> None:
    await state.set_state(MaterialsFSM.pvc)
    await message.answer(
        "—É–∫–∞–∂–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥ —Ç—Ä—É–±–æ–∫ –ü–í–• (–≤ —à—Ç—É–∫–∞—Ö).",
        reply_markup=nav_kb([BTN_SKIP]),
    )


@router.message(MaterialsFSM.pvc)
async def input_pvc(message: types.Message, state: FSMContext) -> None:
    if message.text in (BTN_BACK, BTN_HOME):
        return await exit_nav(message, state, message.text)
    value = only_digits(message.text or "")
    if value is None:
        return await message.answer("—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–ª–∏ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª.")
    await state.update_data(pvc=value)
    await ask_tape(message, state)


async def ask_tape(message: types.Message, state: FSMContext) -> None:
    await state.set_state(MaterialsFSM.tape)
    await message.answer(
        "—É–∫–∞–∂–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥ –∫–ª–µ–π–∫–æ–π –ª–µ–Ω—Ç—ã (–≤ —à—Ç—É–∫–∞—Ö).",
        reply_markup=nav_kb([BTN_SKIP]),
    )


@router.message(MaterialsFSM.tape)
async def input_tape(message: types.Message, state: FSMContext) -> None:
    if message.text in (BTN_BACK, BTN_HOME):
        return await exit_nav(message, state, message.text)
    value = only_digits(message.text or "")
    if value is None:
        return await message.answer("—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–ª–∏ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª.")
    await state.update_data(tape=value)
    await ask_photos_intro(message, state)


async def ask_photos_intro(message: types.Message, state: FSMContext) -> None:
    await state.set_state(MaterialsFSM.photos)
    keyboard = ReplyKeyboardBuilder()
    keyboard.button(text=BTN_CONFIRM)
    keyboard.button(text=BTN_DEL_LAST)
    keyboard.adjust(2)
    keyboard.button(text=BTN_BACK)
    keyboard.button(text=BTN_HOME)
    keyboard.adjust(2, 2)
    await message.answer(
        "üì∏ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –∫—Ä–µ–ø–ª–µ–Ω–∏—è. –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –ø–æ–¥—Ä—è–¥.\n"
        f"–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ ¬´{BTN_CONFIRM}¬ª.",
        reply_markup=keyboard.as_markup(resize_keyboard=True),
    )


@router.message(MaterialsFSM.photos, F.photo)
async def on_photo(message: types.Message, state: FSMContext) -> None:
    data = await state.get_data()
    photos: list[dict[str, str]] = data.get("photos", [])
    file_id = message.photo[-1].file_id
    time_label = _format_time_label(message.date)
    photos.append({"file_id": file_id, "time_label": time_label})
    await state.update_data(photos=photos)
    await message.answer(
        f"—Ñ–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ({len(photos)} —à—Ç). –º–æ–∂–µ—Ç–µ –ø—Ä–∏—Å–ª–∞—Ç—å –µ—â—ë –∏–ª–∏ ¬´{BTN_CONFIRM}¬ª."
    )


@router.message(MaterialsFSM.photos, F.text == BTN_DEL_LAST)
async def del_last_photo(message: types.Message, state: FSMContext) -> None:
    data = await state.get_data()
    photos: list[dict[str, str]] = data.get("photos", [])
    if photos:
        photos.pop()
        await state.update_data(photos=photos)
        await message.answer(f"–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ñ–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ. –æ—Å—Ç–∞–ª–æ—Å—å: {len(photos)}.")
    else:
        await message.answer("—Å–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ –ø—É—Å—Ç.")


@router.message(MaterialsFSM.photos, F.text == BTN_CONFIRM)
async def confirm_upload(message: types.Message, state: FSMContext) -> None:
    data = await state.get_data()
    user_id = data["user_id"]
    row = data["row"]
    photos: list[dict[str, str]] = data.get("photos", [])
    if not photos:
        await message.answer("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.")
        return

    sheets = _get_sheets_service()
    try:
        drive = _get_drive_service()
    except Exception as exc:  # pragma: no cover - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è
        logger.exception("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Ö—Ä–∞–Ω–µ–Ω–∏—è: %s", exc)
        await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
        )
        return

    try:
        day_title: str = data["day_title"]
        saved_names: list[str] = []

        for index, entry in enumerate(photos, start=1):
            file_id = entry["file_id"]
            time_label = entry.get("time_label") or _format_time_label(dt.datetime.now())

            telegram_file = await message.bot.get_file(file_id)
            downloaded = await message.bot.download_file(telegram_file.file_path)
            content = _ensure_bytes(downloaded)

            ext = _normalize_extension(Path(telegram_file.file_path).suffix)
            mime = _guess_mime_type(ext)

            ordinal = index
            while True:
                candidate = f"{time_label}_{user_id}_{ordinal:02d}{ext}"
                try:
                    await asyncio.to_thread(
                        drive.save_photo,
                        content,
                        candidate,
                        day_title,
                        content_type=mime,
                    )
                except YaDiskError as exc:
                    if exc.status == 409:
                        ordinal += 1
                        continue
                    raise
                saved_names.append(candidate)
                break

        if not saved_names:
            raise RuntimeError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ")

        public_url = await asyncio.to_thread(drive.folder_public_link, day_title)
        if not public_url:
            raise RuntimeError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ø–∞–ø–∫—É –¥–Ω—è")

        await asyncio.to_thread(
            sheets.save_materials_block,
            row,
            pvd_m=data.get("pvd", 0),
            pvc_pcs=data.get("pvc", 0),
            tape_pcs=data.get("tape", 0),
            folder_link=public_url,
        )
        logger.info(
            "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: user_id=%s, row=%s, —Ñ–æ—Ç–æ=%s, —Å—Å—ã–ª–∫–∞=%s",
            user_id,
            row,
            len(saved_names),
            public_url,
        )
    except YaDiskError as exc:  # pragma: no cover - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        logger.exception("–û—à–∏–±–∫–∞ API –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: %s", exc)
        if exc.status in {401, 403}:
            await message.answer(
                "–¢–æ–∫–µ–Ω –Ø–Ω–¥–µ–∫—Å-–î–∏—Å–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ —É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ—Ç –ø—Ä–∞–≤. "
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ç–æ–∫–µ–Ω –≤ .env."
            )
        else:
            await message.answer(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
            )
        return
    except Exception as exc:  # pragma: no cover - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        logger.exception("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: %s", exc)
        await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
        return

    await message.answer("üìé —Ñ–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –≤–æ–∑–≤—Ä–∞—â–∞—é –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é‚Ä¶")
    await state.clear()
    from features.main_menu import show_menu

    await show_menu(message)


@router.message(MaterialsFSM.photos)
async def photos_fallback(message: types.Message, state: FSMContext) -> None:
    if message.text in (BTN_BACK, BTN_HOME):
        return await exit_nav(message, state, message.text)
    await message.answer("–ø—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.")


async def exit_nav(message: types.Message, state: FSMContext, key: str) -> None:
    data = await state.get_data()
    await state.clear()
    if key == BTN_HOME:
        from features.main_menu import show_menu

        return await show_menu(message)
    await _render_shift_menu(message, data.get("user_id"), data.get("row"))


def _ensure_bytes(downloaded) -> bytes:
    try:
        if hasattr(downloaded, "read"):
            content = downloaded.read()
        else:
            content = downloaded
    finally:
        close = getattr(downloaded, "close", None)
        if callable(close):
            try:
                close()
            except Exception:  # pragma: no cover - best effort
                logger.debug("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –ø–æ—Ç–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞", exc_info=True)
    if isinstance(content, str):
        content = content.encode()
    return bytes(content)


def _normalize_extension(suffix: str) -> str:
    suffix = (suffix or "").lower()
    if not suffix.startswith("."):
        suffix = f".{suffix}" if suffix else ""
    if suffix in {"", ".jpeg", ".jpg", ".jpe"}:
        return ".jpg"
    return suffix


def _guess_mime_type(ext: str) -> str:
    mapping = {
        ".jpg": "image/jpeg",
        ".jpeg": "image/jpeg",
        ".png": "image/png",
        ".webp": "image/webp",
        ".heic": "image/heic",
    }
    return mapping.get(ext, "application/octet-stream")


def _format_day_title(day: dt.date) -> str:
    return f"–§–æ—Ç–æ–æ—Ç—á–µ—Ç - {day:%d.%m.%Y}"


def _format_time_label(value: dt.datetime) -> str:
    if value.tzinfo is None:
        value = value.replace(tzinfo=dt.timezone.utc)
    local = value.astimezone()
    return local.strftime("%H%M%S")
